Fred Buffington                Menu and Status Bar            oasys@sbcglobal.net            06-14-02 (  :  )       PBDLL                  259  10796    MenuStat.bas'€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€  ã ' Example DDT with menu AND Status bar  ã ' fred c buffington  ã ' Most has been gleaned from searches of the PBForum so most of this  ã ' is thanks to others. The only code that is purely mine is to modify  ã ' the menu text to change and remove ampersands for display purposes.  ã ' PBdll/pbwin code.  ã '€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€  ã '€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€  ã #Compile Exe  ã '#compile dll  ã #Include "WIN32API.INC"  ã #Include "COMMCTRL.INC"  ã '#RESOURCE "jpostddt.pbr" 'use your own pbr for icon  ã %ID_LISTB1       = 24  ã %ID_CHART        = 401  ã %ID_EMPLO        = 402  ã %ID_PAYEE        = 403  ã %ID_SYNON        = 404  ã %ID_CUSTO        = 405  ã %ID_CALC         = 406  ã %ID_NOTES        = 407  ã %ID_INSERT       = 409  ã %ID_INSERTH      = 410  ã %ID_RTOGGLE      = 411  ã %ID_STOGGLE      = 412  ã %ID_EXIT         = 429  ã %ID_OPTION1      = 433  ã %ID_OPTION2      = 434  ã %ID_HELP         = 455  ã %ID_ABOUT        = 456  ã %ID_DELETE       = 457  ã %ID_PYRLCODE     = 459  ã %ID_AUTOCOMPLETE = 460  ã %IDC_LISTBOX     = 24  ã %ID_ListBox2     = 601  ã   ã    Global hWnd As Long  ã    Global hStatus  As Long  ã    Global wParam As Long  ã    Global pin%  ã    Global hDlg As Long  ã    Global LLines$()  ã    Global ghInst As Long  ã    Global hFont&  ã    Global hFont2&  ã    Global hFont3&  ã    Global AutoComplete&  ã    Global coid$  ã    Global Rev%  ã    Global PRDT$  ã   ã    Global keep_ap$  ã    Global Found%  ã    Global xfld&  ã    Global new_id&  ã    Global old_tamt As Cux  ã   ã 'Declare Statements  ã   ã Declare CallBack Function DlgCallback()  ã '€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€  ã ' PBMAIN - load and show a dialog  ã '€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€  ã Function PbMain() As Long  ã     Local I As Long  ã     Local nScreenWidth As Long  ã     Local nScreenHeight As Long  ã     Dim pth$  ã     Dim LLines$(1)  ã 'set this on initially  ã     AutoComplete&=1  ã '-------------------------------------------------------  ã   ã   test$=COMMAND$  ã   ã   If test$<>"" Then pin%=VAL(MID$(test$,1,2)):coid$=MID$(test$,3)  ã   Local result As Long  ã   xfld&=103  ã   Local hMenu  As Long  ã   Local hPopup1 As Long  ã   Local hPopup2 As Long  ã   Local hPopup3 As Long  ã   ã   Menu New Bar To hMenu  ã   ã   Menu New PopUp To hPopup1  ã   Menu Add String, hPopup1, "&Chart of Accounts", %ID_Chart, %MF_ENABLED  ã   Menu Add String, hPopup1, "&Employee File",     %ID_Emplo, %MF_ENABLED  ã   Menu Add String, hPopup1, "&Payee File",        %ID_Payee, %MF_ENABLED  ã   Menu Add String, hPopup1, "&Synonym File",      %ID_Synon, %MF_ENABLED  ã   Menu Add String, hPopup1, "C&ustomer File",     %ID_Custo, %MF_ENABLED  ã   Menu Add String, hPopup1, "-",                          0, 0  ã   Menu Add String, hPopup1, "&Journal Notes",     %ID_NOTES, %MF_ENABLED  ã   Menu Add String, hPopup1, "-",                          0, 0  ã   Menu Add String, hPopup1, "E&xit",              %ID_EXIT, %MF_ENABLED  ã   Menu Add PopUp, hMenu, "&File", hPopup1, %MF_ENABLED  ã   ã   Menu New PopUp To hPopup2  ã   Menu Add String, hPopup2, "&Insert Record",                         %ID_Insert, %MF_ENABLED  ã   Menu Add String, hPopup2, "-",      0, 0  ã   Menu Add String, hPopup2, "Increment Reference On/Off",             %ID_RTOGGLE,%MF_ENABLED  ã   Menu Add String, hPopup2, "&Reverse Sign of Amount On/Off",         %ID_STOGGLE,%MF_ENABLED  ã   Menu Add String, hPopup2, "&Auto Complete Description Field Off/On",%ID_AUTOCOMPLETE,%MF_ENABLED  ã   Menu Add String, hPopup2, "-",      0, 0  ã   Menu Add String, hPopup2, "&Popup Calculator",                      %ID_CALC, %MF_ENABLED  ã   Menu Add PopUp, hMenu, "&Edit", hPopup2, %MF_ENABLED  ã   ã   Menu New PopUp To hPopup3  ã   Menu Add String, hPopup3, "&Contents - Processing", %ID_HELP,    %MF_ENABLED  ã   Menu Add String, hPopup3, "&How to Delete a Record",%ID_Delete,  %MF_ENABLED  ã   Menu Add String, hPopup3, "&How to Insert a Record",%ID_InsertH, %MF_ENABLED  ã   Menu Add String, hPopup3, "&Payroll Codes",         %ID_PYRLCODE,%MF_ENABLED  ã   Menu Add String, hPopup3, "-",      0, 0  ã   Menu Add String, hPopup3, "&About",                 %ID_ABOUT,   %MF_ENABLED  ã   Menu Add PopUp, hMenu, "&Help", hPopup3, %MF_ENABLED  ã   ã   nScreenWidth = GetSystemMetrics(%SM_CXSCREEN )  ã   nScreenHeight = GetSystemMetrics(%SM_CYSCREEN )  ã '-----------------------  ã 'setup dialog controls  ã '-----------------------  ã   Dialog New %NULL, "DDT example with menu and Status bar",,, 431, 300, %WS_SYSMENU To hDlg '%WS_SYSMENU TO hDlg  ã '-----------------------------------------------------  ã 'lines to make a sunken frame rather than using frame  ã '-----------------------------------------------------  ã   Control Add Line,hDlg,25,"",  2,  0,420,  1,%SS_BLACKFRAME And %SS_GRAYRECT  ã   Control Add Line,hDlg,26,"",  2,  0,  1,259,%SS_BLACKFRAME And %SS_GRAYRECT  ã   Control Add Line,hDlg,27,"",  3,258,420,  1,%SS_WHITERECT 'AND %SS_BLACKFRAME 'GRAYFRAME 'WHITERECT 'AND %SS_GRAYFRAME'WHITEFRAME 'BLACKFRAME  ã   Control Add Line,hDlg,28,"",423,  1,  1,258,%SS_WHITERECT 'AND %SS_GRAYFRAME'BLACKFRAME  ã '----------------------------------------------------  ã   ã   Control Add Line,hDlg,23,"",10,15,410,1,,%WS_EX_WINDOWEDGE  ã   Control Add ListBox,hDlg,%ID_LISTB1,LLines$(),10,27,408,140,%LBS_SORT Or %LBS_USETABSTOPS Or %WS_VSCROLL,%WS_EX_CLIENTEDGE 'STATICEDGE 'WINDOWEDGE  ã '-------------------------------------------  ã 'Get the fixed font values for possible use  ã '-------------------------------------------  ã   hFont& = GetStockObject(%SYSTEM_FIXED_FONT)  ã   hFont2& = GetStockObject(%ANSI_FIXED_FONT)  ã   hFont3& = GetStockObject(%OEM_FIXED_FONT)  ã   Control Send hDlg, %ID_LISTB1, %WM_SETFONT, hFont3&, %TRUE 'control # is 24 %ID_LISTB1  ã   ã   ã   Control Add Frame,hDlg,209,"", 10,177,396, 23,,%WS_EX_WINDOWEDGE  ã   Menu Attach hMenu, hDlg  ã '-------------------------------------------  ã 'create the status window  ã '-------------------------------------------  ã   hStatus = CreateStatusWindow(%WS_CHILD Or %WS_CLIPSIBLINGS Or %WS_DLGFRAME Or %WS_VISIBLE _  ã               Or %SBS_SIZEGRIP,"", hDlg, 200)  ã '  ghInst = GetModuleHandle("whatever.exe")  ã 'put icon info program  ã '  SendMessage hDlg, %WM_SETICON, %ICON_SMALL, LoadIcon(ghInst, "PROGRAM")  ã '---------------------------------------------------------  ã 'start the dialog diaplaying and call the callback routine  ã '---------------------------------------------------------  ã   Dialog Show Modal hDlg Call DlgCallback To Result  ã 'close all files when exiting  ã   Close  ã   ã End Function  ã   ã '€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€  ã ' Callback for main dialog  ã '€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€  ã CallBack Function DlgCallback()  ã   Local Hinst As Long ', Wparam AS LONG ', ztext AS ASCIIZ * 255  ã   Select Case CbMsg  ã   ã     Case %WM_MENUSELECT  ã        Local zText As Asciiz * 300, mii As MENUITEMINFO  ã        Local zztext As Asciiz * 300  ã        mii.cbSize     = SizeOf(mii)  ã        mii.fMask      = %MIIM_STRING  ã        mii.cch        = SizeOf(zText)  ã        mii.dwTypeData = VarPtr(zText)  ã        mii.wID        = LoWrd(CBWPARAM)  ã        GetMenuItemInfo CbLParam, LoWrd(CBWPARAM), 0&, ByVal VarPtr(mii)  ã        xx$=ztext  ã        zztext=ztext  ã '--------------------------------------------------------------  ã 'modify status bar text display for ampersand and special text  ã '--------------------------------------------------------------  ã        If Mid$(xx$,2,2)="Ch" Or Mid$(xx$,2,2)="Em" Or Mid$(xx$,2,2)="Pa" Or Mid$(xx$,2,2)="Sy" Then  ã           xxx$="Display "+xx$:xx$=xxx$  ã        End If  ã        If InStr(xx$,"ustomer")>0 Then xxx$="Display "+xx$:xx$=xxx$  ã        If Mid$(xx$,2,6)="About" Then xx$="Information about the prohgram here"  ã        If Mid$(xx$,1,5)="E&xit" Then xx$="Exit the program - Return to Menu"  ã        zztext=xx$  ã '-------------------------------  ã ' remove ampersands from text  ã '-------------------------------  ã        LL&=INSTR(xx$,"&")  ã        If LL&>0 Then  ã           If LL&=1 Then  ã              xxx$=MID$(xx$,2)  ã           Else  ã              xxx$=MID$(xx$,1,LL&-1)+MID$(xx$,LL&+1)  ã           End If  ã           zztext=xxx$  ã        End If  ã '-------------------------------  ã ' put the text on the status bar  ã '-------------------------------  ã        SendMessage hStatus, %SB_SETTEXT, 0, VarPtr(zzText)  ã       Function = 0  ã       Exit Function  ã   ã      Case %WM_HELP '&H53  ã         MsgBox "Help selected"  ã      Case %WM_SYSCOMMAND  ã           If (CbWParam And &hFFF0) = %SC_SCREENSAVE Then Function = 1  ã      Case %WM_COMMAND  ã         Select Case CbCtl  ã            Case %IDOK 'trap enter key  ã            Case %ID_CHART '401  ã               MsgBox "Chart of accounts clicked"  ã            Case %ID_EMPLO '402  ã               MsgBox "Employee file clicked"  ã            Case %ID_PAYEE '403  ã               MsgBox "payee file clicked"  ã            Case %ID_SYNON '404  ã               MsgBox "synonym file clicked"  ã            Case %ID_CUSTO '405  ã               MsgBox "customer file clicked"  ã            Case %ID_NOTES '407  ã               MsgBox "Notes clicked"  ã   ã            Case %ID_EXIT '429  ã                 Dialog End CbHndl, 0  ã            Case %ID_INSERT  ã                 MsgBox "insert record selected"  ã            Case %ID_RTOGGLE  ã                 MsgBox "rtoggle selected"  ã            Case %ID_STOGGLE  ã                 MsgBox "s toggle selected"  ã            Case %ID_AUTOCOMPLETE  ã                 MsgBox "autocomples selected"  ã            Case %ID_CALC  ã                 MsgBox "calculator selected"  ã            Case %ID_INSERTH  ã                 MsgBox "inser selected"  ã            Case %ID_PYRLCODE  ã                 MsgBox "payroll codes selected"  ã            Case 455 'help  ã                 MsgBox "Help selected"  ã   ã            Case 456 'about  ã                 MsgBox "about selected"  ã            Case %ID_PYRLCODE '459 payroll codes  ã   ã               MsgBox "Payroll Codes listing selected"  ã         End Select  ã   ã      Case %WM_USER + 999&  ã         Control Set Focus hDlg, CbLParam  ã   End Select  ã End Function  ãFred Buffington                Short Cuts without COM         oasys@sbcglobal.net            06-14-02 (  :  )       PBDLL                  99   2790     Shortcuts.ba'--------------------------------------------------------------------------------ã'Fred Buffington - oasys@sbcglobal.net ã'--------------------------------------------------------------------------------ãã#Compile Exe ãOption Explicit ã  ã#Include "win32api.inc" ã  ãType ShortItemId ã   cb As Long ã   abID As Byte ãEnd Type ã  ãType ITEMIDLIST ã   mkid As ShortItemId ãEnd Type ã  ãFunction GetSpecialFolder( ByVal CSIDL As Long ) As String ã  ã    Dim idlstr   As Long ã    Dim szPath   As Asciiz * %MAX_PATH ã    Dim IDL As ITEMIDLIST ã  ã    idlstr = SHGetSpecialFolderLocation( 0, CSIDL, ByVal VarPtr( IDL ) ) ã    If idlstr = 0 Then ã   idlstr = SHGetPathFromIDList( ByVal IDL.mkid.cb, szPath ) ã   If idlstr Then szPath = Trim$( szPath ) ã    End If ã  ã    If szPath = "" Then ã   Select Case CSIDL ã   Case %CSIDL_WINDOWS ã  GetWindowsDirectory szPath, SizeOf( szPath ) ã  szPath = Trim$( szPath ) ã   End Select ã    End If ã  ã    If szPath > "" Then szPath = RTrim$( szPath, "\" ) & "\" ã    Function = szPath ã  ãEnd Function ã  ãFunction CreateShortCut( ByVal sLinkFileName As String, ByVal sExeName As String ) As Long ã  ã    Dim a As Long ã    Dim FF As Long ã    Dim sPath As String ã    Dim sFileName As String ã    Dim szTemp As Asciiz * %MAX_PATH ã  ã    GetTempPath SizeOf( szTemp ), szTemp ã    If szTemp > "" Then szTemp = Trim$( szTemp, "\" ) & "\" ã  ã    a = InStr( -1, sLinkFileName, Any ":\" ) ã    If a = 0 Then Exit Function ã    sPath = RTrim$( Left$( sLinkFileName, a ), "\" ) ã    sFileName = Trim$( Mid$( sLinkFileName, a + 1 ) ) ã  ã    FF = FreeFile ã    Open szTemp & "setup.inf" For Output As #FF ã    Print #FF, "[version]" ã    Print #FF, "signature=" & Chr$( 34 ) & "$chicago$" & Chr$( 34 ) ã    Print #FF, "[Linknames]" ã    Print #FF, "UpdateInis=Addlink" ã    Print #FF, "[Addlink]" ã    Print #FF, "setup.ini, progman.groups,, " _ ã   & Chr$( 34 ) & "group0=" & sPath & Chr$( 34 ) ã    Print #FF, "setup.ini, group0,," _ ã   & Chr$( 34 ) & Chr$( 34 ) & sFileName & Chr$( 34 )  _ ã   & "," & Chr$( 34) & Chr$( 34 ) _ ã   & sExeName & Chr$( 34 ) & Chr$( 34 ) _ ã   & ",,0," & Chr$( 34 ) ã  ã    Close #FF ã  ã    Shell "rundll setupx.dll,InstallHinfSection Linknames 132 " & szTemp & "setup.inf" ã    Kill szTemp & "setup.inf" ã  ã    ErrClear ã    a = GetAttr( sLinkFileName & ".lnk" ) ã    Function = IsFalse( Err ) ã  ãEnd Function ã  ãFunction PbMain() ã  ã'"My Notepad" seems to fail and get's "MyNotepad" instead, don't know why... ã  ã    If CreateShortCut( _ ã     GetSpecialFolder( %CSIDL_DESKTOP ) & "MyNotepad" _ ã   , GetSpecialFolder( %CSIDL_WINDOWS ) & "NOTEPAD.EXE" _ ã   ) Then ã  ã   MsgBox "OK" ã  ã    End If ã  ãEnd Function ãFred Buffington                Set Default Printer            oasys@sbcglobal.net            06-14-02 (  :  )       PBDLL                  399  14063    DefPrnter.ba'PACKET: PBDLL.ABC ã'COMPILER: PBDLL 6.0 up ã'AUTHOR: Pierre Bellisle - modified for command line by ã'Fred Buffington - oasys@sbcglobal.net ã'DATE: 05/05.2003 ã'Pierre Bellisle ã'bellisle@vif.com ã'--------------------------------------------------------------------------------ãã'The need for this grew out of a network using another ã'OS and windows as clients on this other OS. ã ã'The workstations on this other OS could have local printers ã'(connected to the other OS physically) and/or remote printers ã'(which to the windows workstation are local or network printers). ã ã'The trouble is only 1 remote printer on the other OS can be used ã'(others could be attached but it goes to the same place). ã ã'The other OS sends the report and whatever printer is the default for the workstation. ã ã'So, if you wanted to print to a different printer you had to change ã'it in the workstation software (which is easy enough but an extra step). ã'This program changes the default printer ã'on the windows machine and has an optional "command line" ã'ability so that in conjuntion with some other software i wrote i can change the default printer on the workstation, if needed, ã'and send the report to the specified printer without the user ã'making a change other that selecting the printer on the other OS. ã ã'At first I used a free downloaded program to change the default printer. This works fine but is 126K. ã ã'The compiled code here comiles to 27K on PB 6.11 ã ã'Thanks to Pierre Bellisle for most of the code. ã'I added the option for the modeless dialog and command line ã'process (a minor part). ã ã ã'Routine to set Windows default printer, ã'works under 95/98/Me/NT/2000/XP. ã ã#COMPILE EXE             '#Win 702# ã#DIM ALL ã#INCLUDE "Win32Api.Inc"  '2003-03-27 ã ã$AppName         = "PrinterSelect" ã ã%FramePS         = 1001 ã%ButtonSetPS     = 1002 ã%ButtonInfoPS    = 1003 ã%ButtonExitPS    = 1004 ã%ListboxPS       = 1005 ã%LabelPS         = 1006 ã ã%PAll            = 1 ã%PName           = 2 ã%PDriver         = 3 ã%PPort           = 4 ã%PNonSelect      = 5 ã%PRetry          = 6 ã%MaxPrinterCount = 20 ã ã'-------------------------- ã'my added global fcb. ãGLOBAL dialogistrue& ã'------------------------- ãGLOBAL hDlg              AS LONG ãGLOBAL lResult           AS LONG ãGLOBAL hList             AS DWORD ãGLOBAL PrinterDefault    AS LONG ãGLOBAL PrinterDefaultOld AS LONG ãGLOBAL PrinterCount      AS LONG ãGLOBAL PList()           AS STRING ã'_______________________________________________________________________ _______ ã ã'------------------------------ ã'set the default printer here ã'------------------------------ ãSUB SetPrinterDefault() ã LOCAL OsInfo      AS OSVERSIONINFO ã LOCAL PD          AS PRINTER_DEFAULTS ã LOCAL PI5         AS PRINTER_INFO_5 ã LOCAL DeviceLine  AS STRING ã LOCAL Win         AS STRING ã LOCAL PrinterName AS STRING ã LOCAL hPrinter    AS LONG ã LOCAL Need        AS LONG ã LOCAL LastError   AS LONG ã LOCAL Retval      AS LONG ã ã OsInfo.dwOsVersionInfoSize = SIZEOF(OsInfo) ã GetVersionEx OsInfo ã ã IF OsInfo.dwPlatformId = %VER_PLATFORM_WIN32_WINDOWS THEN 'Windows 95/98/Me ã ã   'Get the selected printer ã   PrinterName = PList(PrinterDefault, %PName) ã   IF PrinterName = "" THEN ã     MSGBOX "Win 9x error: No printer specified !", _ã	%MB_ICONERROR OR %MB_OK, $AppName ã     EXIT SUB ã   END IF ã ã   'Set the PRINTER_DEFAULTS members ã   PD.pDatatype = 0& ã   PD.DesiredAccess = %PRINTER_ALL_ACCESS OR PD.DesiredAccess ã ã   'Get an handle to the printer ã   Retval = OpenPrinter(BYCOPY PrinterName, hPrinter, PD) ã   IF Retval = 0 THEN ã     MSGBOX "Win 9x error: " & PrinterName & " is not a valid printer !", _ã	%MB_ICONERROR OR %MB_OK, $AppName ã     EXIT SUB ã   END IF ã ã   'Check how many bytes we need ã   Retval = GetPrinter(hPrinter, 5, BYVAL 0, BYVAL 0, Need) ã   REDIM PArray((Need \ 4)) AS LONG ã ã   'Get info ã   Retval = GetPrinter(hPrinter, 5, PArray(0), Need, Need) ã   IF Retval = %False THEN ã     MSGBOX "Win 9x error: " & STR$(Retval) & " bytes unavaible !", _ã	%MB_ICONERROR OR %MB_OK, $AppName ã     EXIT SUB ã   END IF ã ã   PI5.pPrinterName             = PArray(0) ã   PI5.pPortName                = PArray(1) ã   PI5.Attributes               = PArray(2) ã   PI5.DeviceNotSelected        = PArray(3) ã   PI5.TransmissionRetryTimeout = PArray(4) ã   PI5.Attributes               = %PRINTER_ATTRIBUTE_DEFAULT 'This make it the default printer ã   Retval = SetPrinter(hPrinter, BYVAL 5, BYVAL VARPTR(PI5), BYVAL 0) ã   IF Retval = 0 THEN ã       MSGBOX "SetPrinter failed" ã       EXIT SUB ã   END IF ã ã   ClosePrinter hPrinter ã ã ELSE 'Windows NT/2000/XP ã ã   DeviceLine = PList(PrinterDefault, %PName)   & "," & _ ã                PList(PrinterDefault, %PDriver) & "," & _ ã                PList(PrinterDefault, %PPort) ã ã   'Store WIN.INI, [WINDOWS], DEVICE = ã   Retval = WriteProfileString("windows", "Device", BYCOPY DeviceLine) ã ã   'Cause all applications to reload the INI file ã   Win = "Windows" ã   Retval = SendMessage(%HWND_BROADCAST, %WM_WININICHANGE, 0, BYCOPY VARPTR(Win)) ã ã END IF ãEND SUB ã'_______________________________________________________________________ _______ ã ãFUNCTION GetPrinterDefault() AS STRING ã LOCAL zPrinterDefault AS ASCIIZ * 255 ã ã 'Will return something like...     Epson LQ-500=EPSON24,LPT1:,15,45 ã '                                  Printer Name=Driver,Port,NonSelect,Retry ã GetProfileString "WINDOWS", "DEVICE", ",,,", zPrinterDefault, SIZEOF(zPrinterDefault) ã FUNCTION = zPrinterDefault ã ãEND FUNCTION ã'_______________________________________________________________________ _______ ã'---------------------------- ã'Get a list of all printers ã'to compare or display and ã'let user choose optionally ã'-------------------------- ãSUB GetPrinterAll() ã LOCAL Section         AS ASCIIZ * 32767 ã LOCAL SectionPtr      AS ASCIIZ PTR ã LOCAL sPrinterDefault AS STRING ã LOCAL Retval          AS LONG ã ã sPrinterDefault = PARSE$(GetPrinterDefault, "," , 1) ã'msgbox "im here "+sprinterDefault ã CONTROL SET TEXT hDlg, %LabelPS, "Default is: " & sPrinterDefault ã ã Retval = GetProfileSection("PrinterPorts", Section, SIZEOF(Section)) ã SectionPtr = VARPTR(Section) ã PrinterCount = 0 ã DIM pList(%MaxPrinterCount, 7) AS STRING ã DO ã   IF LEN(@SectionPtr) = 0 THEN EXIT DO ã    INCR PrinterCount ã    IF PrinterCount > %MaxPrinterCount THEN EXIT LOOP ã    PList(PrinterCount, %PAll)       = @SectionPtr                      'Epson LQ-500=EPSON24,LPT1:,15,45 ã    PList(PrinterCount, %PName)      = PARSE$(@SectionPtr, ANY "=", 1)  'Epson LQ-500 ã    PList(PrinterCount, %PDriver)    = PARSE$(@SectionPtr, ANY "=,", 2) 'EPSON24 ã    PList(PrinterCount, %PPort)      = PARSE$(@SectionPtr, ANY "=,", 3) 'LPT1: ã    PList(PrinterCount, %PNonSelect) = PARSE$(@SectionPtr, ANY "=,", 4) '15 ã    PList(PrinterCount, %PRetry)     = PARSE$(@SectionPtr, ANY "=,", 5) '45 ã    IF sPrinterDefault  = PList(PrinterCount, %PName) THEN PrinterDefaultOld = PrinterCount ã    IF dialogistrue& THEN 'do only if command line not sent ã      LISTBOX ADD hDlg, %ListboxPS, PList(PrinterCount, %PName) ã      'LISTBOX ADD hDlg, %ListboxPS, @SectionPtr ã    END IF ã    SectionPtr = SectionPtr + LEN(@SectionPtr) + 1 ã LOOP ã IF dialogistrue& THEN 'do only if command line not sent ã 'Highlight the default ã   SendMessage hList, %LB_SETSEL, PrinterDefaultOld - 1, 0 ã   SendMessage hList, %LB_SETCURSEL, PrinterDefaultOld - 1, 0 ã   UpdateWindow hList ã END IF ãEND SUB ã'_______________________________________________________________________ _______ ãCALLBACK FUNCTION DlgProc2() ã ã SELECT CASE CBMSG ã     CASE %WM_COMMAND ã       SELECT CASE CBCTL ã         CASE 103 ã           DIALOG END CBHNDL,1 ã           lResult=0 ã           EXIT FUNCTION ã       END SELECT ã ã      IF CBCTLMSG=%BN_CLICKED THEN ã        IF CBCTL=%IDOK THEN ã          DIALOG END CBHNDL,1 ã          lResult=0 ã        ELSEIF CBCTL=%IDCANCEL THEN ã          DIALOG END CBHNDL,0 ã          lResult=0 ã        END IF ã      END IF ã END SELECT ãEND FUNCTION ã ãCALLBACK FUNCTION DlgProc() AS LONG ã LOCAL Retval AS LONG ã ã SELECT CASE CBMSG ã   CASE %WM_INITDIALOG ã     CONTROL HANDLE hDlg, %ListboxPS TO hList ã     GetPrinterAll ã ã   CASE %WM_COMMAND ã     SELECT CASE CBCTL ã ã       CASE %ButtonSetPS ã         IF CBCTLMSG = %BN_CLICKED THEN ã           CONTROL SEND hDlg, %ListboxPS, %LB_GetCurSel, 0, 0 TO Retval ã           PrinterDefault = Retval + 1 ã           SetPrinterDefault ã         END IF ã ã       CASE %ListboxPS ã         IF CBCTLMSG = %LBN_DBLCLK THEN ã           CONTROL SEND hDlg, %ListboxPS, %LB_GetCurSel, 0, 0 TO Retval ã           PrinterDefault = Retval + 1 ã           SetPrinterDefault ã         END IF ã ã       CASE %ButtonInfoPS ã         IF CBCTLMSG = %BN_CLICKED THEN ã           CONTROL SEND hDlg, %ListboxPS, %LB_GetCurSel, 0, 0 TO Retval ã           INCR Retval ã           MSGBOX "Name:"   & $TAB & PList(Retval, %PName)      & $CRLF & _ ã                  "Driver:" & $TAB & PList(Retval, %PDriver)    & $CRLF & _ ã                  "Port:"   & $TAB & PList(Retval, %PPort)      & $CRLF & _ ã                  "Select:" & $TAB & PList(Retval, %PNonSelect) & $CRLF & _ ã                  "Retry:"  & $TAB & PList(Retval, %PRetry), _ã				%MB_ICONINFORMATION OR %MB_OK, $AppName ã         END IF ã ã       CASE  %ButtonExitPS, %IDCANCEL ã         IF CBCTLMSG = %BN_CLICKED THEN DIALOG END CBHNDL, 0 ã ã     END SELECT ã ã   CASE %WM_WININICHANGE ã     'Here, we will be inform by Window if the default printer change ã     CONTROL SET TEXT hDlg, %LabelPS, "Default is: " & PARSE$(GetPrinterDefault, "," , 1) ã ã END SELECT ã ãEND FUNCTION ã'_______________________________________________________________________ _______ ã ãFUNCTION PBMAIN AS LONG ã LOCAL Pnam$ ã LOCAL RetVal AS LONG ã LOCAL found% ã LOCAL k&,Start&,Endit&,Count& ã LOCAL msg$ ã Pnam$=COMMAND$ ã IF Pnam$="" THEN ã'--------------------------------- ã'no command line entry detected so ã'show the modal dialog to choose ã'default printer. ã'--------------------------------- ã   dialogistrue&=1 ã   DIALOG NEW 0, $AppName, , , 280, 150, _ ã             %WS_POPUP OR %WS_VISIBLE OR %WS_CLIPSIBLINGS OR %WS_CAPTION OR _ ã             %WS_SYSMENU OR %WS_MINIMIZEBOX OR %DS_3DLOOK OR %DS_NOFAILCREATE _ ã             OR %DS_SETFONT, %WS_EX_CONTROLPARENT TO hDlg ã ã   CONTROL ADD FRAME, hDlg, %FramePS, "Printer", 9, 9, 264, 93 ã ã   CONTROL ADD LISTBOX, hDlg, %ListboxPS, , 21, 24, 240, 76, _ ã             %WS_CHILD OR %WS_VISIBLE OR %WS_BORDER OR %WS_VSCROLL OR _ ã             %WS_TABSTOP OR %LBS_NOTIFY, 0 ã ã   CONTROL ADD LABEL, hDlg, %LabelPS, "Default Printer is...", 21, 110, 240, 12 ã ã   CONTROL ADD BUTTON, hDlg, %ButtonSetPS, "Set default printer", 9, 126, 130, 18, _ ã             %WS_CHILD OR %WS_VISIBLE OR %WS_TABSTOP OR %BS_CENTER OR %BS_VCENTER ã ã   CONTROL ADD BUTTON, hDlg, %ButtonInfoPS, "Info", 150, 126, 30, 18, _ ã             %WS_CHILD OR %WS_VISIBLE OR %WS_TABSTOP OR %BS_CENTER OR %BS_VCENTER ã ã   CONTROL ADD BUTTON, hDlg, %ButtonExitPS, "Exit", 192, 126, 78, 18, _ ã             %WS_CHILD OR %WS_VISIBLE OR %WS_TABSTOP OR %BS_CENTER OR %BS_VCENTER ã ã   DIALOG SHOW MODAL hDlg, CALL DlgProc ã ELSE ã'-------------------------------- ã'command line entry detexted, so ã'try to set default based on name ã'from the command line ã'-------------------------------- ã   dialogistrue&=0 ã   GetPrinterAll ã   found%=0 ã ã   FOR k&=1 TO PrinterCount ã    IF PList(k&, %PName)=Pnam$ THEN RetVal=k& : k&=%MAXPRINTERCOUNT:found%=1 ã   NEXT k& ã   IF RetVal THEN ã     IF RetVal<>PrinterDefaultOld AND found%=1 THEN ã       PrinterDefault = Retval ' not coming from listbox so don't to add + 1 ã       SetPrinterDefault ã       msg$="Default Printer Set to:" ã     ELSEIF found%=1 AND RetVal=PrinterDefaultOld THEN ã       msg$="Default printer already is:" ã'     else 'Not needed error message will be shown in msgbox if no match ã'       msg$="Command Line doesn't match any" ã     END IF ã'-------------------------------- ã'modeless dialog to display if ã'result was successful. auto ã'self-destructs after couple of ã'seconds or press ok ã'------------------------------- ã     DIALOG NEW 0,"Set Default Printer",,,130,60,%WS_SYSMENU OR %WS_CAPTION,_ã			%WS_EX_CONTROLPARENT TO hDlg ã'                   , _ ã'                  %WS_POPUP OR %WS_VISIBLE OR %WS_CLIPSIBLINGS OR %WS_CAPTION OR _ ã'                  %WS_SYSMENU OR %WS_MINIMIZEBOX OR %DS_3DLOOK OR %DS_NOFAILCREATE _ ã'               OR %DS_SETFONT, %WS_EX_CONTROLPARENT TO hDlg ã       CONTROL ADD LABEL, hDlg,101,msg$,10,5,100,12 ã       CONTROL ADD LABEL, hDlg,102,Pnam$,10,20,120,12,%SS_NOWORDWRAP ã       CONTROL ADD BUTTON, hDlg,103,"OK",40,40,50,15 ã      lResult=1 ã     DIALOG SHOW MODELESS hdlg CALL dlgproc2 ã'------------------- ã'start a timer for ã'the dialog ã'------------------- ã     Start&=VAL(RIGHT$(TIME$,2)) ã     Endit&=Start&+2 ã     IF Endit&>=59 THEN Endit&=Endit&-59 ã     DO ã        ' Allow messages to be dispatched ã       DIALOG DOEVENTS ã       IF VAL(RIGHT$(TIME$,2))>endit& THEN ã         lresult=0 ã       END IF ã     LOOP WHILE lResult>0 'VAL(RIGHT$(TIME$,2))<Endit& OR Count&<100000 OR lResult>0 ''x ã ã   ELSE ã'----------------------- ã'this may not be needed ã'either - may show in ã'getall subroutine ã'----------------------- ã     MSGBOX "Invalid Printer name specified",%MB_ICONERROR,"No Match Found" ã   END IF ã END IF ãEND FUNCTION ã'___________________________________________________ ã ã' ã'------------------ ã ã ãã'Pierre Bellisle ã'bellisle@vif.com ã'modified for command line ability by Fred Buffington ã ã